<?xml version="1.0" encoding="UTF-8"?>
<jasperReport xmlns="http://jasperreports.sourceforge.net/jasperreports"
              xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
              xsi:schemaLocation="http://jasperreports.sourceforge.net/jasperreports
              http://jasperreports.sourceforge.net/xsd/jasperreport.xsd"
              name="ProfessionalInvoice" pageWidth="280" columnWidth="260"
              leftMargin="10" rightMargin="10" topMargin="10" bottomMargin="10">

    <!-- Parameters -->
    <parameter name="orderId" class="java.lang.String"/>
    <parameter name="totalHT" class="java.lang.Double"/>
    <parameter name="totalTTC" class="java.lang.Double"/>
    <parameter name="createdOn" class="java.time.LocalDateTime"/>
    <parameter name="taxDetails" class="java.util.Collection"/>

    <!-- Fields -->
    <field name="menuItemName" class="java.lang.String"/>
    <field name="quantity" class="java.lang.Integer"/>
    <field name="priceHT" class="java.lang.Double"/>
    <field name="priceTTC" class="java.lang.Double"/>
    <field name="totalHT" class="java.lang.Double"/>
    <field name="totalTTC" class="java.lang.Double"/>

    <!-- Title Band -->
    <title>
        <band height="80">
            <staticText>
                <reportElement x="0" y="0" width="260" height="30" forecolor="#000000"/>
                <textElement textAlignment="Center" verticalAlignment="Middle">
                    <font size="16" isBold="true"/>
                </textElement>
                <text><![CDATA[INVOICE]]></text>
            </staticText>
            <staticText>
                <reportElement x="0" y="30" width="80" height="20"/>
                <text><![CDATA[Order ID:]]></text>
            </staticText>
            <textField>
                <reportElement x="80" y="30" width="180" height="20"/>
                <textFieldExpression><![CDATA[$P{orderId}]]></textFieldExpression>
            </textField>
            <staticText>
                <reportElement x="0" y="50" width="80" height="20"/>
                <text><![CDATA[Date:]]></text>
            </staticText>
            <textField>
                <reportElement x="80" y="50" width="180" height="20"/>
                <textFieldExpression><![CDATA[$P{createdOn}.format(java.time.format.DateTimeFormatter.ofPattern("yyyy-MM-dd HH:mm"))]]></textFieldExpression>
            </textField>
        </band>
    </title>

    <!-- Column Header -->
    <columnHeader>
        <band height="30">
            <staticText>
                <reportElement x="0" y="0" width="120" height="30" backcolor="#EEEEEE"/>
                <text><![CDATA[Item]]></text>
            </staticText>
            <staticText>
                <reportElement x="120" y="0" width="30" height="30" backcolor="#EEEEEE"/>
                <text><![CDATA[Qty]]></text>
            </staticText>
            <staticText>
                <reportElement x="150" y="0" width="50" height="30" backcolor="#EEEEEE"/>
                <text><![CDATA[HT]]></text>
            </staticText>
            <staticText>
                <reportElement x="200" y="0" width="60" height="30" backcolor="#EEEEEE"/>
                <text><![CDATA[TTC]]></text>
            </staticText>
        </band>
    </columnHeader>

    <!-- Detail Band -->
    <detail>
        <band height="20">
            <textField>
                <reportElement x="0" y="0" width="120" height="20"/>
                <textFieldExpression><![CDATA[$F{menuItemName}]]></textFieldExpression>
            </textField>
            <textField>
                <reportElement x="120" y="0" width="30" height="20"/>
                <textFieldExpression><![CDATA[$F{quantity}]]></textFieldExpression>
            </textField>
            <textField>
                <reportElement x="150" y="0" width="50" height="20"/>
                <textFieldExpression><![CDATA[$F{priceHT}]]></textFieldExpression>
            </textField>
            <textField>
                <reportElement x="200" y="0" width="60" height="20"/>
                <textFieldExpression><![CDATA[$F{priceTTC}]]></textFieldExpression>
            </textField>
        </band>
    </detail>

    <!-- Tax Details Band -->
    <summary>
        <band height="150">
            <line>
                <reportElement x="0" y="0" width="260" height="1"/>
            </line>

            <!-- Subtotal -->
            <staticText>
                <reportElement x="150" y="10" width="60" height="20"/>
                <text><![CDATA[Total HT:]]></text>
            </staticText>
            <textField>
                <reportElement x="210" y="10" width="50" height="20"/>
                <textFieldExpression><![CDATA[$P{totalHT}]]></textFieldExpression>
            </textField>

            <!-- Tax Details Table -->
            <staticText>
                <reportElement x="0" y="40" width="260" height="20" backcolor="#EEEEEE"/>
                <text><![CDATA[Tax Details]]></text>
            </staticText>

            <componentElement>
                <reportElement x="0" y="60" width="260" height="20"/>
                <jr:table xmlns:jr="http://jasperreports.sourceforge.net/jasperreports/components" xsi:schemaLocation="http://jasperreports.sourceforge.net/jasperreports/components http://jasperreports.sourceforge.net/xsd/components.xsd">
                    <datasetRun subDataset="taxDataset">
                        <datasetParameter name="taxDetails">
                            <datasetParameterExpression><![CDATA[$P{taxDetails}]]></datasetParameterExpression>
                        </datasetParameter>
                    </datasetRun>
                    <jr:column width="100">
                        <jr:columnHeader height="20">
                            <staticText>
                                <reportElement x="0" y="0" width="100" height="20"/>
                                <text><![CDATA[Tax Name]]></text>
                            </staticText>
                        </jr:columnHeader>
                        <jr:detailCell height="20">
                            <textField>
                                <reportElement x="0" y="0" width="100" height="20"/>
                                <textFieldExpression><![CDATA[((java.util.Map.Entry)$F{taxEntry}).getKey().getName()]]></textFieldExpression>
                            </textField>
                        </jr:detailCell>
                    </jr:column>
                    <jr:column width="80">
                        <jr:columnHeader height="20">
                            <staticText>
                                <reportElement x="0" y="0" width="80" height="20"/>
                                <text><![CDATA[Rate]]></text>
                            </staticText>
                        </jr:columnHeader>
                        <jr:detailCell height="20">
                            <textField>
                                <reportElement x="0" y="0" width="80" height="20"/>
                                <textFieldExpression><![CDATA[((java.util.Map.Entry)$F{taxEntry}).getKey().getRate() + "%"]]></textFieldExpression>
                            </textField>
                        </jr:detailCell>
                    </jr:column>
                    <jr:column width="80">
                        <jr:columnHeader height="20">
                            <staticText>
                                <reportElement x="0" y="0" width="80" height="20"/>
                                <text><![CDATA[Amount]]></text>
                            </staticText>
                        </jr:columnHeader>
                        <jr:detailCell height="20">
                            <textField>
                                <reportElement x="0" y="0" width="80" height="20"/>
                                <textFieldExpression><![CDATA[((java.util.Map.Entry)$F{taxEntry}).getValue()]]></textFieldExpression>
                            </textField>
                        </jr:detailCell>
                    </jr:column>
                </jr:table>
            </componentElement>

            <!-- Grand Total -->
            <staticText>
                <reportElement x="150" y="100" width="60" height="20" isBold="true"/>
                <text><![CDATA[Total TTC:]]></text>
            </staticText>
            <textField>
                <reportElement x="210" y="100" width="50" height="20" isBold="true"/>
                <textFieldExpression><![CDATA[$P{totalTTC}]]></textFieldExpression>
            </textField>

            <!-- Footer -->
            <staticText>
                <reportElement x="0" y="130" width="260" height="20" forecolor="#888888"/>
                <textElement textAlignment="Center"/>
                <text><![CDATA[Thank you for your business!]]></text>
            </staticText>
        </band>
    </summary>

    <!-- Tax Dataset -->
    <subDataset name="taxDataset">
        <field name="taxEntry" class="java.util.Map.Entry"/>
    </subDataset>
</jasperReport>